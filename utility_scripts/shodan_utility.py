#! /usr/bin/env python3

import sys, shodan
from getpass import getpass

class shodan_search(object):

    def check(self):
        if len(sys.argv) != 4:
            print("Usage: python3 pentesting-multitool.py ssearch <search query> <file>\n"
                  "(Search arguments separated by \"-\") Example: \"ip:8.8.8.0/24-port:80\"")
            exit()

    def settingApi(self):
        try:
            print("Please, set your APIKey here:")
            shodanKeyString = getpass('API Key:' )
            self.shodanApi = shodan.Shodan(shodanKeyString)
        except:
            print("The specified APIKey is invalid, please insert another one.")
            exit()

    def run(self):
        file = open(sys.argv[3], 'w')
        search_query = sys.argv[2].replace("-", ' ')
        try:
            results = self.shodanApi.search(search_query)
            file.write("Total results: %s" % (len(results['matches'])))
            file.write("\n")
            for result in results['matches']:
                file.write("TITLE: %s \n" % (result['title']))
                file.write("IP: %s \n" % (result['ip_str']))
                file.write("PORT: %s \n" % (result['port']))
                file.write("ISP: %s \n" % (result['isp']))
                file.write('\n')
                file.write("//////////ADDITIONAL DATA////////// \n")
                file.write(result['data'])
                file.write("=========================")
                file.write('\n')

        except:
            print("Search parameters unavailable for your APIKey. More info in documentation.")
            exit()

    def __init__(self):
        self.check()
        self.settingApi()
        self.run()
        exit()