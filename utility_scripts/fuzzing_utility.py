#! /usr/bin/env python3

import sys
from scapy.all import (IP, ICMP, UDP, TCP, sr1, wrpcap, fuzz, RandString, RandIP)

class fuzzing_attack(object):

    def check(self):
        if len(sys.argv) != 7:
            print('Usage: python pentesting-multitool.py fuzzing <number of generations> <number of packets> <layer (UDP, TCP, ICMP)> <ip destination> <PCAP file name>')
            exit()

    def generator(self):
        n_generations = int(sys.argv[2])
        n_packets = int(sys.argv[3])
        ip_dst = sys.argv[5]

        selected_layer = sys.argv[4]

        # Select the final layer for randomize

        if selected_layer == "UDP":
            layer = UDP()
        elif selected_layer == "TCP":
            layer = TCP()
        else:
            layer = ICMP()

        for i in range(n_generations):
            print('Generating packets. (%s of %s)\n' % (i+1, n_generations))
            pkts_send = [fuzz(IP(dst=ip_dst, src=RandIP()))/fuzz(layer)/str(RandString()) for j in range(n_packets)]
            self.send_pkts(pkts_send)

    def send_pkts(self, pkts):

        print('Sending packets generated.\n')

        # Packet generated because if there isn't any response the value will be None

        no_response_pkt = IP(src="127.0.0.1", dst="127.0.0.1")/"No response received"

        for pkt in pkts:
            self.pkts_write.append(pkt)
            pkt_received = sr1(pkt, verbose=0, timeout=1)

            if pkt_received == None:
                self.pkts_write.append(no_response_pkt)
            else:
                self.pkts_write.append(pkt_received)

    def write_pcap(self, pkts_write):
        filename = sys.argv[6]

        print('Writing pcap file.\n')
        wrpcap(filename, pkts_write)

        print('Done, all packets generated.')

    def __init__(self):
        self.pkts_write = []
        self.check()
        self.generator()
        self.write_pcap(self.pkts_write)